#!/bin/bash

# KINOTEKA - ะกะบัะธะฟั ะทะฐะฟััะบะฐ ะดะปั Linux/macOS
# ะะฐะฟััะบะฐะตั Node.js ัะตัะฒะตั ะธ ะพัะบััะฒะฐะตั ะฟัะธะปะพะถะตะฝะธะต ะฒ ะฑัะฐัะทะตัะต

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ              ๐ฌ KINOTEKA - ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั             โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะพะฒะตัะบะฐ ัััะฐะฝะพะฒะบะธ Node.js
if ! command -v node &> /dev/null
then
    echo "โ Node.js ะฝะต ัััะฐะฝะพะฒะปะตะฝ!"
    echo "๐ฅ ะฃััะฐะฝะพะฒะธัะต Node.js ั https://nodejs.org/"
    exit 1
fi

echo "โ Node.js ะพะฑะฝะฐััะถะตะฝ: $(node --version)"
echo ""

# ะัะพะฒะตัะบะฐ ัััะฐะฝะพะฒะบะธ ะทะฐะฒะธัะธะผะพััะตะน
if [ ! -d "node_modules" ]; then
    echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
    npm install
    echo ""
fi

# ะะฐะฟััะบ ัะตัะฒะตัะฐ ะฒ ัะพะฝะต
echo "๐ ะะฐะฟััะบ ัะตัะฒะตัะฐ..."
node server.js &
SERVER_PID=$!

# ะกะพััะฐะฝัะตะผ PID ัะตัะฒะตัะฐ
echo $SERVER_PID > .server.pid

# ะะดัะผ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ..."
sleep 3

# ะัะบััะฒะฐะตะผ ะฑัะฐัะทะตั
echo "๐ ะัะบัััะธะต ะฟัะธะปะพะถะตะฝะธั ะฒ ะฑัะฐัะทะตัะต..."
URL="http://localhost:3000"

# ะะฟัะตะดะตะปัะตะผ ะบะพะผะฐะฝะดั ะดะปั ะพัะบัััะธั ะฑัะฐัะทะตัะฐ ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ะะก
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    if command -v xdg-open &> /dev/null; then
        xdg-open "$URL" 2>/dev/null
    elif command -v gnome-open &> /dev/null; then
        gnome-open "$URL" 2>/dev/null
    else
        echo "โ๏ธ  ะะต ัะดะฐะปะพัั ะพัะบัััั ะฑัะฐัะทะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ"
        echo "๐ ะัะบัะพะนัะต ะฒัััะฝัั: $URL"
    fi
elif [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    open "$URL"
elif [[ "$OSTYPE" == "cygwin" ]] || [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "win32" ]]; then
    # Windows (Git Bash)
    start "$URL"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ              โ ะัะธะปะพะถะตะฝะธะต ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะพ!             โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ URL: $URL"
echo "๐ง PID ัะตัะฒะตัะฐ: $SERVER_PID"
echo ""
echo "ะะปั ะพััะฐะฝะพะฒะบะธ ะฝะฐะถะผะธัะต Ctrl+C"
echo ""

# ะะดัะผ ะทะฐะฒะตััะตะฝะธั ัะตัะฒะตัะฐ
wait $SERVER_PID

# ะัะธัะฐะตะผ PID ัะฐะนะป ะฟัะธ ะฒััะพะดะต
rm -f .server.pid

echo ""
echo "๐ ะกะตัะฒะตั ะพััะฐะฝะพะฒะปะตะฝ"

